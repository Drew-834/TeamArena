@inherits LayoutComponentBase
@inject IJSRuntime JSRuntime

<div class="relative min-h-screen bg-gray-900">
    
    @* Always render the body - blur it if modal is showing *@
    <main class="@(_showTermsModal ? "filter blur-sm pointer-events-none" : "") transition-all duration-300">
        @Body
    </main>

    <TermsOfUseModal IsVisible="@_showTermsModal" OnAccepted="HandleTermsAccepted" />

    @* Copyright footer *@
    <footer class="absolute bottom-2 left-0 w-full text-center text-gray-600 text-xs p-2 @(_showTermsModal ? "filter blur-sm" : "") transition-all duration-300">
        &copy; @DateTime.Now.Year Drew Carrillo. All Rights Reserved.
    </footer>
</div>

@code {
    private bool _showTermsModal = false;
    private bool _termsChecked = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_termsChecked)
        {
            _termsChecked = true;
            try
            {
                // Check if terms have been accepted in this session
                var accepted = await JSRuntime.InvokeAsync<string>("sessionStorage.getItem", "termsAccepted");
                
                if (accepted != "true")
                {
                    _showTermsModal = true;
                    StateHasChanged();
                }
            }
            catch (Exception ex) 
            {
                Console.WriteLine($"Error checking session storage: {ex.Message}");
                // On error, show terms modal to be safe
                _showTermsModal = true;
                StateHasChanged();
            }
        }
    }

    private async Task HandleTermsAccepted()
    {
        _showTermsModal = false;
        try
        {
            await JSRuntime.InvokeVoidAsync("sessionStorage.setItem", "termsAccepted", "true");
        }
        catch (Exception ex) 
        {
            Console.WriteLine($"Error setting session storage: {ex.Message}");
        }
        StateHasChanged();
    }
}