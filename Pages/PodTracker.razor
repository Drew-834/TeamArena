@page "/podtracker"
@namespace GameScoreboard.Pages
@using GameScoreboard.Models
@using GameScoreboard.Services
@using GameScoreboard.Data
@using System.Globalization

@inject IDataService DataService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject AppState AppState

<div class="bg-gray-900 min-h-screen text-white p-8">

    @if (!_isAuthenticated)
    {
        <div id="password-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-500 @(_showPasswordModal ? "opacity-100" : "opacity-0 pointer-events-none")">
            <div class="bg-gray-800 p-8 rounded-lg shadow-xl border border-purple-500 transform transition-transform duration-300 ease-out @(_showPasswordModal ? "scale-100 opacity-100" : "scale-95 opacity-0")">
                <h2 class="text-2xl font-bold text-purple-400 mb-4">Enter Admin Password</h2>
                <div class="mb-4">
                    <input type="password" @bind="PasswordInputValue" @bind:event="oninput" @onkeydown="HandlePasswordKeydown"
                           class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-purple-500 placeholder-gray-500"
                           placeholder="Password" />
                </div>
                @if (!string.IsNullOrEmpty(_passwordError))
                {
                    <p class="text-red-500 text-sm mb-4">@_passwordError</p>
                }
                <button @onclick="CheckPassword"
                        class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-md font-semibold transition-colors">
                    Authenticate
                </button>
            </div>
        </div>
    }
    else
    {
        <h1 class="text-4xl font-bold text-yellow-400 mb-8">Pod Metrics Tracker</h1>
        <button @onclick="NavigateBack" class="absolute top-4 left-4 px-4 py-2 bg-gray-700 text-yellow-400 rounded font-semibold hover:bg-gray-600 transition-colors z-10">
            &lt; Back to Pods
        </button>

        <!-- Import Section -->
        <div class="mb-8 p-5 bg-gray-800 rounded-lg border border-gray-700">
            <h2 class="text-xl font-semibold text-yellow-400 mb-4">Import Pod Tracker Data</h2>

            <div class="flex flex-wrap gap-4 mb-4">
                <div class="flex-1 min-w-[200px]">
                    <label class="block text-sm font-medium text-gray-300 mb-1">Period</label>
                    <select class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-yellow-500" @onchange="OnPeriodChanged">
                        <option value="">Select Period...</option>
                        @foreach (var period in _periods)
                        {
                            <option value="@period" selected="@(period == _selectedPeriod)">@period</option>
                        }
                    </select>
                </div>
            </div>

            <div class="mb-3">
                <label class="block text-sm font-medium text-gray-300 mb-1">
                    Paste Full Excel Sheet
                    <span class="text-gray-500">(copy all rows from the pod tracker including pod headers)</span>
                </label>
                <textarea @bind="_pastedData" @bind:event="oninput" rows="10"
                          class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white font-mono text-sm focus:outline-none focus:ring-2 focus:ring-yellow-500 placeholder-gray-500"
                          placeholder="Select all data in the Excel pod tracker (Ctrl+A) and paste here (Ctrl+V)...&#10;&#10;The parser will auto-detect:&#10;  - Pod section headers (Matt-Category Advisors, etc.)&#10;  - Employee names and all KPI columns&#10;  - New pods and new advisors"></textarea>
            </div>

            <div class="flex items-center gap-4">
                <button @onclick="HandlePastedData" disabled="@_isParsing"
                        class="px-5 py-2 bg-blue-600 hover:bg-blue-500 disabled:bg-gray-600 text-white rounded-lg font-semibold transition-colors">
                    @(_isParsing ? "Processing..." : "Process Pasted Data")
                </button>

                @if (!string.IsNullOrEmpty(_uploadStatusMessage))
                {
                    <span class="text-sm @(_uploadSuccess ? "text-green-400" : "text-red-400")">@_uploadStatusMessage</span>
                }
            </div>

            @* Parse Results Panel *@
            @if (_parseResults != null && _parseResults.Any())
            {
                <div class="mt-5 p-4 bg-gray-700 rounded-lg border border-gray-600">
                    <h3 class="text-lg font-semibold text-yellow-400 mb-3">Parse Results</h3>

                    <div class="flex flex-wrap gap-3 mb-4">
                        <span class="px-3 py-1 bg-gray-800 rounded-full text-sm">
                            <span class="text-yellow-400 font-bold">@_parseResults.Count</span> pods detected
                        </span>
                        <span class="px-3 py-1 bg-gray-800 rounded-full text-sm">
                            <span class="text-green-400 font-bold">@_parseResults.Sum(r => r.MatchedMembers.Count)</span> matched
                        </span>
                        @{ var newCount = _parseResults.Sum(r => r.NewMembers.Count); }
                        @if (newCount > 0)
                        {
                            <span class="px-3 py-1 bg-gray-800 rounded-full text-sm">
                                <span class="text-blue-400 font-bold">@newCount</span> new members created
                            </span>
                        }
                        @{ var unmatchedCount = _parseResults.Sum(r => r.UnmatchedNames.Count); }
                        @if (unmatchedCount > 0)
                        {
                            <span class="px-3 py-1 bg-gray-800 rounded-full text-sm">
                                <span class="text-orange-400 font-bold">@unmatchedCount</span> unmatched
                            </span>
                        }
                    </div>

                    @foreach (var pod in _parseResults)
                    {
                        <div class="mb-2 p-3 bg-gray-800 rounded cursor-pointer hover:bg-gray-750"
                             @onclick="() => SelectPodFromResults(pod.SystemName)">
                            <div class="flex items-center gap-2 flex-wrap">
                                <span class="@(pod.IsNew ? "text-blue-400" : "text-green-400") text-lg">@(pod.IsNew ? "★" : "✓")</span>
                                <span class="font-semibold">@pod.ExcelName</span>
                                @if (pod.ExcelName != pod.SystemName)
                                {
                                    <span class="text-gray-500">→</span>
                                    <span class="text-yellow-400">@pod.SystemName</span>
                                }
                                @if (pod.IsNew)
                                {
                                    <span class="text-xs bg-blue-600 px-2 py-0.5 rounded">NEW POD</span>
                                }
                                <span class="text-gray-400 text-sm ml-auto">
                                    @(pod.MatchedMembers.Count + pod.NewMembers.Count) members
                                    @if (pod.NewMembers.Any()) { <span class="text-blue-400">(@pod.NewMembers.Count new)</span> }
                                </span>
                            </div>
                            @if (pod.NewMembers.Any())
                            {
                                <div class="text-xs text-blue-300 mt-1 ml-7">New: @string.Join(", ", pod.NewMembers)</div>
                            }
                            @if (pod.UnmatchedNames.Any())
                            {
                                <div class="text-xs text-orange-300 mt-1 ml-7">Could not match: @string.Join(", ", pod.UnmatchedNames)</div>
                            }
                        </div>
                    }

                    @if (_parseLog.Any())
                    {
                        <details class="mt-3">
                            <summary class="text-sm text-gray-400 cursor-pointer hover:text-gray-200">Detailed parse log (@_parseLog.Count entries)</summary>
                            <div class="mt-2 p-3 bg-gray-900 rounded text-xs font-mono max-h-48 overflow-y-auto space-y-0.5">
                                @foreach (var log in _parseLog)
                                {
                                    string logClass = log.StartsWith("⚠") ? "text-yellow-400" : log.StartsWith("★") ? "text-blue-400" : log.StartsWith("✗") ? "text-red-400" : "text-green-400";
                                    <div class="@logClass">@log</div>
                                }
                            </div>
                        </details>
                    }

                    @if (_parsedPodData.Any())
                    {
                        <div class="mt-4 flex gap-3">
                            <button @onclick="SaveAllPods" disabled="@_isSaving"
                                    class="px-5 py-2 bg-green-600 hover:bg-green-500 disabled:bg-gray-600 text-white rounded-lg font-semibold transition-colors">
                                @(_isSaving ? "Saving All..." : $"Save All {_parsedPodData.Count} Pods")
                            </button>
                            <button @onclick="ClearParseResults"
                                    class="px-4 py-2 bg-gray-600 hover:bg-gray-500 text-gray-200 rounded-lg text-sm transition-colors">
                                Clear Results
                            </button>
                        </div>
                    }
                </div>
            }
        </div>

        <!-- Data Grid Section -->
        <div class="flex flex-col md:flex-row gap-8">
            <div class="flex-grow md:w-3/4">
                <div class="bg-gray-800 rounded-lg border border-gray-700 p-4 overflow-x-auto">
                    <div class="flex items-center justify-between mb-3">
                        <h2 class="text-xl font-semibold text-yellow-400">
                            @(_selectedPod ?? "Select a Pod")
                            @if (_parsedPodData.ContainsKey(_selectedPod ?? ""))
                            {
                                <span class="text-sm text-green-400 ml-2">(data loaded)</span>
                            }
                        </h2>
                        <select class="px-3 py-1 bg-gray-700 border border-gray-600 rounded focus:outline-none focus:border-yellow-500 text-sm" @onchange="OnPodChanged">
                            <option value="">Select Pod...</option>
                            @foreach (var pod in _pods)
                            {
                                <option value="@pod" selected="@(pod == _selectedPod)">@pod</option>
                            }
                        </select>
                    </div>

                    <div class="mb-3 flex flex-wrap gap-2 text-xs">
                        <span class="px-2 py-1 bg-gray-700 rounded">RPH: <strong class="text-yellow-400">7</strong></span>
                        <span class="px-2 py-1 bg-gray-700 rounded">App Eff: <strong class="text-yellow-400">7</strong></span>
                        <span class="px-2 py-1 bg-gray-700 rounded">PM Eff: <strong class="text-yellow-400">5</strong></span>
                        <span class="px-2 py-1 bg-gray-700 rounded">Warranty: <strong class="text-yellow-400">5</strong></span>
                        <span class="px-2 py-1 bg-gray-700 rounded">Acc Attach: <strong class="text-yellow-400">5</strong></span>
                        <span class="px-2 py-1 bg-gray-700 rounded">Surveys: <strong class="text-yellow-400">3</strong></span>
                    </div>

                    @if (_currentPodMembers != null && _currentPodMembers.Any() && !string.IsNullOrEmpty(_selectedPod))
                    {
                        <table class="w-full min-w-[900px] border-collapse">
                            <thead>
                                <tr class="bg-gray-700">
                                    <th class="p-3 text-left sticky left-0 bg-gray-700 z-10">Name</th>
                                    @foreach (var metricKey in _podMetricKeys)
                                    {
                                        <th class="p-3 text-center">@TeamMember.GetMetricDisplayName(metricKey)</th>
                                    }
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var member in _currentPodMembers.OrderBy(m => m.Name))
                                {
                                    <tr class="border-b border-gray-700 hover:bg-gray-700/50 transition-colors">
                                        <td class="p-3 font-medium sticky left-0 bg-gray-800 hover:bg-gray-700/50 z-10">@member.Name</td>
                                        @foreach (var metricKey in _podMetricKeys)
                                        {
                                            <td>
                                                <input type="text"
                                                       class="w-full px-2 py-1 bg-gray-600 border border-gray-500 rounded focus:outline-none focus:border-yellow-500 focus:bg-gray-500 text-center"
                                                       placeholder="-"
                                                       @bind="_inputValues[member.Id][metricKey]"
                                                       @bind:event="oninput" />
                                            </td>
                                        }
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                    else if (!string.IsNullOrEmpty(_selectedPod))
                    {
                        <p class="text-gray-500">No team members found for this pod.</p>
                    }
                    else
                    {
                        <p class="text-gray-500">Select a pod above or paste data to get started.</p>
                    }
                </div>

                <div class="mt-6 flex items-center justify-end gap-4">
                    <button @onclick="SaveMetrics" disabled="@(_isSaving || string.IsNullOrEmpty(_selectedPod))"
                            class="px-6 py-2 bg-green-600 hover:bg-green-500 disabled:bg-gray-600 rounded font-semibold transition-colors">
                        @(_isSaving ? "Saving..." : "Save Current Pod")
                    </button>
                    <button @onclick="ClearInputs" class="text-sm text-gray-400 hover:text-gray-200 underline focus:outline-none">
                        Clear Inputs
                    </button>
                </div>
                @if (!string.IsNullOrEmpty(_saveSuccessMessage))
                {
                    <div class="mt-3 p-2 bg-green-800 border border-green-600 text-green-200 rounded text-sm text-right">@_saveSuccessMessage</div>
                }
                @if (!string.IsNullOrEmpty(_saveError))
                {
                    <p class="text-red-500 text-sm mt-2 text-right">@_saveError</p>
                }
            </div>

            <!-- Right Side Panel: Pod Rankings -->
            <div class="md:w-1/4 bg-gray-800 rounded-lg border border-gray-700 p-6 self-start sticky top-8">
                <h2 class="text-2xl font-semibold text-yellow-400 mb-4 border-b border-gray-700 pb-2">Pod Rankings</h2>
                @if (_podRankings != null && _podRankings.Any())
                {
                    <div class="space-y-4">
                        @foreach (var kvp in _podRankings.OrderBy(kv => kv.Key))
                        {
                            <div>
                                <h4 class="font-semibold text-gray-300 mb-1 text-sm">@kvp.Key</h4>
                                <ul class="space-y-1 text-sm">
                                    @foreach (var rm in kvp.Value.Take(5))
                                    {
                                        <li class="flex justify-between items-center @(rm.Rank == 1 ? "text-yellow-400" : rm.Rank <= 3 ? "text-gray-200" : "text-gray-400")">
                                            <span>@rm.Rank. @rm.Name</span>
                                            <span class="font-mono text-xs">@rm.Score.ToString("F0")</span>
                                        </li>
                                    }
                                </ul>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <p class="text-gray-500 italic">No ranking data yet.</p>
                }
            </div>
        </div>
    }
</div>

@code {
    // ── Auth state ──
    private bool _isAuthenticated = false;
    private bool _showPasswordModal = false;
    private string _passwordInput = string.Empty;
    private string _passwordError = string.Empty;
    private const string CorrectPassword = "Admin321";

    // ── Page state ──
    private bool _isSaving = false;
    private bool _isParsing = false;
    private string? _saveError = null;
    private string? _saveSuccessMessage = null;
    private string? _uploadStatusMessage = null;
    private bool _uploadSuccess = false;
    private string _pastedData = string.Empty;

    // ── Data ──
    private List<string> _pods = new();
    private List<string> _periods = new();
    private string? _selectedPod;
    private string? _selectedPeriod;
    private List<TeamMember>? _currentPodMembers;
    private Dictionary<int, Dictionary<string, string>> _inputValues = new();
    private List<TeamMember>? _allPodMembers;
    private Dictionary<string, List<RankedMember>>? _podRankings;

    // ── Parse results ──
    private List<PodParseInfo>? _parseResults;
    private List<string> _parseLog = new();
    private Dictionary<string, Dictionary<int, Dictionary<string, string>>> _parsedPodData = new();

    // ── Constants ──
    private static readonly List<string> _podMetricKeys = new() { "RPH", "AppEff", "PMEff", "Surveys", "WarrantyAttach", "AccAttach" };

    private static readonly Dictionary<string, int> _metricWeights = new(StringComparer.OrdinalIgnoreCase)
    {
        { "AppEff", 7 }, { "WarrantyAttach", 5 }, { "AccAttach", 5 }, { "PMEff", 5 }, { "Surveys", 3 }, { "RPH", 7 }
    };

    private static readonly Dictionary<string, double> _metricTargets = new(StringComparer.OrdinalIgnoreCase)
    {
        { "RPH", 920.0 }, { "AppEff", 6500.0 }, { "PMEff", 4000.0 }, { "Surveys", 4.6 }, { "WarrantyAttach", 10.0 }, { "AccAttach", 20.0 }
    };

    // Pod name alias mapping: Excel name → system name
    private static readonly Dictionary<string, string> _podAliases = new(StringComparer.OrdinalIgnoreCase)
    {
        { "LUIS-DI/HT/Mobile", "Luis the Beast" },
        { "Luis-DI/HT/Mobile", "Luis the Beast" },
    };

    // Non-pod departments to exclude from auto-detection
    private static readonly HashSet<string> _regularDepartments = new(StringComparer.OrdinalIgnoreCase)
    {
        "front", "computers", "warehouse"
    };

    // Keywords that indicate a row is a header/title, not data or a pod name
    private static readonly HashSet<string> _skipKeywords = new(StringComparer.OrdinalIgnoreCase)
    {
        "Employee", "Hours", "Total Revenue", "TPH", "RPH", "Apps", "PMs", "Surveys",
        "Individual", "Pod Performance", "Score", "Warranty", "Accessory", "5 Star",
        "#N/A", "February", "January", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December",
        "Individual Pod Performance"
    };

    // ── Parse result class ──
    private class PodParseInfo
    {
        public string ExcelName { get; set; } = "";
        public string SystemName { get; set; } = "";
        public bool IsNew { get; set; }
        public List<string> MatchedMembers { get; set; } = new();
        public List<string> NewMembers { get; set; } = new();
        public List<string> UnmatchedNames { get; set; } = new();
    }

    // ── Lifecycle ──
    private string PasswordInputValue
    {
        get => _passwordInput;
        set { _passwordInput = value; if (!string.IsNullOrEmpty(_passwordError)) _passwordError = string.Empty; }
    }

    protected override async Task OnInitializedAsync()
    {
        _periods = GeneratePeriods(6);
        try
        {
            var allMembers = (await DataService.GetTeamMembersAsync())?.ToList() ?? new List<TeamMember>();
            _allPodMembers = allMembers
                .Where(m => !_regularDepartments.Contains(m.Department))
                .ToList();
            _pods = _allPodMembers.Select(m => m.Department).Distinct(StringComparer.OrdinalIgnoreCase).OrderBy(d => d).ToList();
            CalculateAllRankings();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error in PodTracker init: {ex.Message}");
        }
        await InvokeAsync(StateHasChanged);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                var isAuth = await JSRuntime.InvokeAsync<string?>("sessionStorage.getItem", "managerAuthenticated");
                if (isAuth == "true") { _isAuthenticated = true; _showPasswordModal = false; await InvokeAsync(StateHasChanged); return; }
            }
            catch { }
            if (!_isAuthenticated)
            {
                await Task.Delay(50);
                _showPasswordModal = true;
                await InvokeAsync(StateHasChanged);
            }
        }
    }

    // ── Period + Pod selection ──
    private List<string> GeneratePeriods(int monthsBack)
    {
        var periods = new List<string>();
        var today = DateTime.Today;
        for (int i = monthsBack; i >= -1; i--)
        {
            var monthStart = new DateTime(today.Year, today.Month, 1).AddMonths(-i);
            periods.Add($"Mid-{monthStart:MMM yyyy}");
            periods.Add($"EOM-{monthStart:MMM yyyy}");
        }
        return periods.OrderByDescending(p => p).ToList();
    }

    private void OnPeriodChanged(ChangeEventArgs e) { _selectedPeriod = e.Value?.ToString(); }

    private void OnPodChanged(ChangeEventArgs e)
    {
        _selectedPod = e.Value?.ToString();
        LoadMembersForSelectedPod();
    }

    private void SelectPodFromResults(string podName)
    {
        _selectedPod = podName;
        LoadMembersForSelectedPod();
        StateHasChanged();
    }

    private void LoadMembersForSelectedPod()
    {
        _currentPodMembers = null;
        _inputValues.Clear();
        _saveError = null;
        _saveSuccessMessage = null;

        if (string.IsNullOrEmpty(_selectedPod)) return;

        _currentPodMembers = _allPodMembers?
            .Where(m => m.Department.Equals(_selectedPod, StringComparison.OrdinalIgnoreCase))
            .ToList();

        InitializeInputValues();

        // If we have parsed data for this pod, overlay it
        if (_parsedPodData.TryGetValue(_selectedPod, out var podData))
        {
            foreach (var (memberId, values) in podData)
            {
                if (_inputValues.ContainsKey(memberId))
                {
                    foreach (var (key, val) in values)
                        _inputValues[memberId][key] = val;
                }
            }
        }
        StateHasChanged();
    }

    private void InitializeInputValues()
    {
        _inputValues.Clear();
        if (_currentPodMembers == null) return;
        foreach (var member in _currentPodMembers)
        {
            var memberInputs = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
            foreach (var key in _podMetricKeys) memberInputs[key] = string.Empty;
            _inputValues[member.Id] = memberInputs;
        }
    }

    // ══════════════════════════════════════════════════════════
    //  PASTE PARSER - handles entire Excel pod tracker sheets
    // ══════════════════════════════════════════════════════════

    private async Task HandlePastedData()
    {
        _parseResults = null;
        _parseLog.Clear();
        _parsedPodData.Clear();
        _uploadStatusMessage = null;
        _uploadSuccess = false;
        _isParsing = true;
        StateHasChanged();

        if (string.IsNullOrEmpty(_selectedPeriod))
        {
            _uploadStatusMessage = "Please select a period first.";
            _isParsing = false;
            return;
        }
        if (string.IsNullOrWhiteSpace(_pastedData))
        {
            _uploadStatusMessage = "Paste area is empty.";
            _isParsing = false;
            return;
        }

        try
        {
            var lines = _pastedData.Split(new[] { '\n', '\r' }, StringSplitOptions.RemoveEmptyEntries);
            if (lines.Length < 3)
            {
                _uploadStatusMessage = "Need more data - paste the full pod tracker sheet.";
                _isParsing = false;
                return;
            }

            // Step 1: Detect column layout from header row
            int nameCol = 0, rphCol = 4, appEffCol = 7, pmEffCol = 10, fiveStarCol = 13, warCol = 15, accCol = 17;
            int headerRowIdx = FindHeaderRow(lines, ref nameCol, ref rphCol, ref appEffCol, ref pmEffCol, ref fiveStarCol, ref warCol, ref accCol);

            if (headerRowIdx >= 0)
                _parseLog.Add($"✓ Header found at row {headerRowIdx + 1}. Columns: Name={nameCol}, RPH={rphCol}, AppEff={appEffCol}, PMEff={pmEffCol}, 5Star={fiveStarCol}, Warranty={warCol}, Acc={accCol}");
            else
                _parseLog.Add("⚠ No header row detected. Using default column layout (Employee at col 0).");

            // Step 2: Walk through lines detecting pods and member data
            var results = new List<PodParseInfo>();
            PodParseInfo? currentPod = null;
            int startRow = headerRowIdx >= 0 ? headerRowIdx + 1 : 0;

            for (int i = startRow; i < lines.Length; i++)
            {
                var cells = lines[i].Split('\t');

                // Skip lines with very few cells
                if (cells.Length < 2) continue;
                if (cells.All(c => string.IsNullOrWhiteSpace(c))) continue;

                // Detect pod section header
                var detectedPodName = DetectPodHeader(cells, nameCol);
                if (detectedPodName != null)
                {
                    string systemName = ResolvePodName(detectedPodName);
                    bool isNew = !PodExistsInSystem(systemName);

                    currentPod = new PodParseInfo { ExcelName = detectedPodName, SystemName = systemName, IsNew = isNew };
                    results.Add(currentPod);

                    if (detectedPodName != systemName)
                        _parseLog.Add($"✓ Pod '{detectedPodName}' → mapped to '{systemName}'");
                    else if (!isNew)
                        _parseLog.Add($"✓ Pod '{detectedPodName}' found in system");
                    else
                        _parseLog.Add($"★ Pod '{detectedPodName}' is new - will be created on save");

                    continue;
                }

                // Skip rows before first pod header is detected
                if (currentPod == null) continue;

                // Skip #N/A rows
                if (IsNARow(cells)) continue;

                // Extract member name
                if (cells.Length <= nameCol) continue;
                string memberName = (cells[nameCol] ?? "").Trim();
                if (string.IsNullOrEmpty(memberName)) continue;

                // Skip if it looks like a sub-header or metadata row
                if (_skipKeywords.Contains(memberName)) continue;

                // Validate it's a real data row (needs numeric data)
                int numericCells = CountNumericCells(cells, nameCol + 1);
                if (numericCells < 2)
                {
                    _parseLog.Add($"⚠ Skipped row '{memberName}' (only {numericCells} numeric values detected)");
                    continue;
                }

                // Match member to existing system entries
                var podMembers = _allPodMembers?
                    .Where(m => m.Department.Equals(currentPod.SystemName, StringComparison.OrdinalIgnoreCase))
                    .ToList() ?? new();

                var matched = MatchMember(memberName, podMembers);

                if (matched == null)
                {
                    // Try all pod members (maybe they moved)
                    var allMatch = MatchMember(memberName, _allPodMembers ?? new());
                    if (allMatch != null)
                    {
                        _parseLog.Add($"⚠ '{memberName}' found in '{allMatch.Department}' → moving to '{currentPod.SystemName}'");
                        allMatch.Department = currentPod.SystemName;
                        matched = allMatch;
                    }
                }

                if (matched == null)
                {
                    // Create new member
                    var newMember = new TeamMember
                    {
                        Name = memberName,
                        Department = currentPod.SystemName,
                        AvatarUrl = "images/avatars/avatar4.png"
                    };

                    try
                    {
                        await DataService.AddTeamMemberAsync(newMember);
                        _allPodMembers ??= new List<TeamMember>();
                        _allPodMembers.Add(newMember);
                        matched = newMember;
                        currentPod.NewMembers.Add(memberName);
                        _parseLog.Add($"★ Created '{memberName}' in '{currentPod.SystemName}'");
                    }
                    catch (Exception ex)
                    {
                        currentPod.UnmatchedNames.Add(memberName);
                        _parseLog.Add($"✗ Failed to create '{memberName}': {ex.Message}");
                        continue;
                    }
                }
                else
                {
                    currentPod.MatchedMembers.Add(memberName);
                }

                // Extract KPI values from known column positions
                var values = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase)
                {
                    ["RPH"] = CleanCurrency(SafeGet(cells, rphCol)),
                    ["AppEff"] = CleanCurrency(SafeGet(cells, appEffCol)),
                    ["PMEff"] = CleanCurrency(SafeGet(cells, pmEffCol)),
                    ["Surveys"] = SafeGet(cells, fiveStarCol).Trim(),
                    ["WarrantyAttach"] = CleanPercentage(SafeGet(cells, warCol)),
                    ["AccAttach"] = CleanPercentage(SafeGet(cells, accCol))
                };

                // Store parsed values
                if (!_parsedPodData.ContainsKey(currentPod.SystemName))
                    _parsedPodData[currentPod.SystemName] = new();
                _parsedPodData[currentPod.SystemName][matched.Id] = values;
            }

            _parseResults = results;

            // Update pod dropdown to include new pods
            foreach (var pod in results)
            {
                if (!_pods.Contains(pod.SystemName, StringComparer.OrdinalIgnoreCase))
                    _pods.Add(pod.SystemName);
            }
            _pods.Sort(StringComparer.OrdinalIgnoreCase);

            // Build summary
            int totalMatched = results.Sum(r => r.MatchedMembers.Count);
            int totalNew = results.Sum(r => r.NewMembers.Count);
            int totalUnmatched = results.Sum(r => r.UnmatchedNames.Count);

            _uploadSuccess = (totalMatched + totalNew) > 0;
            _uploadStatusMessage = $"Parsed {totalMatched + totalNew} members across {results.Count} pods.";
            if (totalNew > 0) _uploadStatusMessage += $" ({totalNew} new members created)";
            if (totalUnmatched > 0) _uploadStatusMessage += $" ({totalUnmatched} could not be matched)";

            _pastedData = string.Empty;

            // Auto-select first pod with data
            if (results.Any())
            {
                _selectedPod = results.First().SystemName;
                LoadMembersForSelectedPod();
            }
        }
        catch (Exception ex)
        {
            _uploadStatusMessage = $"Parse error: {ex.Message}";
            _uploadSuccess = false;
            _parseLog.Add($"✗ Fatal: {ex.Message}");
            Console.WriteLine($"PodTracker parse error: {ex}");
        }
        finally
        {
            _isParsing = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    // ── Header detection ──
    private int FindHeaderRow(string[] lines, ref int nameCol, ref int rphCol, ref int appEffCol, ref int pmEffCol, ref int fiveStarCol, ref int warCol, ref int accCol)
    {
        for (int i = 0; i < Math.Min(lines.Length, 15); i++)
        {
            var cells = lines[i].Split('\t');
            int employeeIdx = Array.FindIndex(cells, c => c.Trim().Equals("Employee", StringComparison.OrdinalIgnoreCase));
            if (employeeIdx < 0) continue;

            nameCol = employeeIdx;

            for (int k = employeeIdx + 1; k < cells.Length; k++)
            {
                string h = cells[k].Trim();
                if (string.IsNullOrEmpty(h)) continue;

                if (h.Contains("RPH", StringComparison.OrdinalIgnoreCase) && rphCol == 4)
                    rphCol = k;
                else if ((h.Contains("App", StringComparison.OrdinalIgnoreCase) && h.Contains("Eff", StringComparison.OrdinalIgnoreCase))
                         || h.StartsWith("Apps", StringComparison.OrdinalIgnoreCase))
                    appEffCol = k + 1;
                else if ((h.Contains("PM", StringComparison.OrdinalIgnoreCase) && h.Contains("Eff", StringComparison.OrdinalIgnoreCase))
                         || h.StartsWith("PMs", StringComparison.OrdinalIgnoreCase))
                    pmEffCol = k + 1;
                else if (h.Contains("Surveys", StringComparison.OrdinalIgnoreCase) || h.Contains("5 Star", StringComparison.OrdinalIgnoreCase)
                         || h.Contains("5-Star", StringComparison.OrdinalIgnoreCase))
                    fiveStarCol = k + 1;
                else if (h.Contains("Warranty", StringComparison.OrdinalIgnoreCase))
                    warCol = k;
                else if (h.Contains("Accessory", StringComparison.OrdinalIgnoreCase))
                    accCol = k;
            }
            return i;
        }
        return -1;
    }

    // ── Pod section header detection ──
    private string? DetectPodHeader(string[] cells, int nameCol)
    {
        int nonEmptyCount = cells.Count(c => !string.IsNullOrWhiteSpace(c));

        // Pod headers typically have 1-3 non-empty cells
        if (nonEmptyCount > 5) return null;

        foreach (var cell in cells)
        {
            string val = cell?.Trim() ?? "";
            if (string.IsNullOrEmpty(val)) continue;
            if (val.Length < 4) continue;
            if (_skipKeywords.Contains(val)) continue;
            if (val.StartsWith("$") || val.StartsWith("#") || val.EndsWith("%")) continue;
            // Skip pure numbers (e.g., "1411")
            if (double.TryParse(val.Replace(",", ""), NumberStyles.Any, CultureInfo.InvariantCulture, out _)) continue;
            // Skip short date-like strings (e.g., "2/22/2026") but not pod names with slashes
            if (val.Length <= 12 && DateTime.TryParse(val, CultureInfo.InvariantCulture, DateTimeStyles.None, out _)) continue;

            if (LooksLikePodName(val))
                return val;
        }
        return null;
    }

    private bool LooksLikePodName(string val)
    {
        // Known pods or aliases
        if (_podAliases.ContainsKey(val)) return true;
        if (PodExistsInSystem(val)) return true;

        // Fuzzy match to existing pod (handles typos)
        if (_allPodMembers != null)
        {
            var existingPods = _allPodMembers.Select(m => m.Department).Distinct(StringComparer.OrdinalIgnoreCase);
            if (existingPods.Any(p => FuzzyMatch(val, p)))
                return true;
        }

        // Heuristic: contains a dash or common pod-name keywords
        string lower = val.ToLowerInvariant();
        if (val.Contains("-") || lower.Contains("pod") || lower.Contains("front") ||
            lower.Contains("advisor") || lower.Contains("computing") || lower.Contains("beast") ||
            lower.Contains("flex") || lower.Contains("mobile") || lower.Contains("category") ||
            lower.Contains("crew") || lower.Contains("end") || lower.Contains("jamie") ||
            lower.Contains("matt") || lower.Contains("luis") || lower.Contains("drew"))
            return true;

        return false;
    }

    private string ResolvePodName(string excelName)
    {
        // Direct alias match
        if (_podAliases.TryGetValue(excelName, out var systemName))
            return systemName;

        // Exact match to existing pod
        if (PodExistsInSystem(excelName))
            return excelName;

        // Fuzzy match against existing pods (handles typos like "Advisros" → "Advisors")
        if (_allPodMembers != null)
        {
            var existingPods = _allPodMembers.Select(m => m.Department).Distinct(StringComparer.OrdinalIgnoreCase).ToList();
            foreach (var existing in existingPods)
            {
                if (FuzzyMatch(excelName, existing))
                {
                    _parseLog.Add($"⚠ Fuzzy matched '{excelName}' → '{existing}' (possible typo in Excel)");
                    return existing;
                }
            }
        }

        return excelName;
    }

    private static bool FuzzyMatch(string a, string b)
    {
        if (a.Length < 5 || b.Length < 5) return false;
        if (Math.Abs(a.Length - b.Length) > 3) return false;

        int distance = LevenshteinDistance(a.ToLowerInvariant(), b.ToLowerInvariant());
        int maxLen = Math.Max(a.Length, b.Length);
        return distance <= 3 && distance < maxLen * 0.2;
    }

    private static int LevenshteinDistance(string s, string t)
    {
        int n = s.Length, m = t.Length;
        var d = new int[n + 1, m + 1];
        for (int i = 0; i <= n; i++) d[i, 0] = i;
        for (int j = 0; j <= m; j++) d[0, j] = j;
        for (int i = 1; i <= n; i++)
            for (int j = 1; j <= m; j++)
            {
                int cost = s[i - 1] == t[j - 1] ? 0 : 1;
                d[i, j] = Math.Min(Math.Min(d[i - 1, j] + 1, d[i, j - 1] + 1), d[i - 1, j - 1] + cost);
            }
        return d[n, m];
    }

    private bool PodExistsInSystem(string name)
    {
        return _allPodMembers?.Any(m => m.Department.Equals(name, StringComparison.OrdinalIgnoreCase)) == true;
    }

    // ── Row classification ──
    private bool IsNARow(string[] cells)
    {
        int naCount = cells.Count(c => (c?.Trim() ?? "").Equals("#N/A", StringComparison.OrdinalIgnoreCase));
        return naCount >= 3;
    }

    private int CountNumericCells(string[] cells, int startCol)
    {
        int count = 0;
        for (int i = startCol; i < cells.Length; i++)
        {
            string val = (cells[i] ?? "").Trim().Replace("$", "").Replace(",", "").Replace("%", "");
            if (double.TryParse(val, NumberStyles.Any, CultureInfo.InvariantCulture, out _))
                count++;
        }
        return count;
    }

    // ── Member matching ──
    private TeamMember? MatchMember(string csvName, List<TeamMember> members)
    {
        if (!members.Any()) return null;
        csvName = csvName.Trim();

        // Exact match
        var match = members.FirstOrDefault(m => m.Name.Equals(csvName, StringComparison.OrdinalIgnoreCase));
        if (match != null) return match;

        // First + last name match (handles slight differences)
        var csvParts = csvName.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (csvParts.Length >= 2)
        {
            string csvFirst = csvParts[0];
            string csvLast = csvParts[^1];

            match = members.FirstOrDefault(m =>
            {
                var mParts = m.Name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
                if (mParts.Length < 2) return false;
                return mParts[0].Equals(csvFirst, StringComparison.OrdinalIgnoreCase)
                    && mParts[^1].Equals(csvLast, StringComparison.OrdinalIgnoreCase);
            });
            if (match != null) return match;
        }

        // First name only match (if unique in pod)
        if (csvParts.Length >= 1)
        {
            string csvFirst = csvParts[0];
            var firstNameMatches = members
                .Where(m => m.Name.Split(' ')[0].Equals(csvFirst, StringComparison.OrdinalIgnoreCase))
                .ToList();
            if (firstNameMatches.Count == 1) return firstNameMatches[0];
        }

        // Contains match (catches partial names, nicknames, etc.)
        if (csvParts.Length >= 2)
        {
            foreach (var m in members)
            {
                bool firstMatch = m.Name.Contains(csvParts[0], StringComparison.OrdinalIgnoreCase);
                bool lastMatch = csvParts.Length > 1 && m.Name.Contains(csvParts[^1], StringComparison.OrdinalIgnoreCase);
                if (firstMatch && lastMatch) return m;
            }
        }

        return null;
    }

    // ── Value extraction helpers ──
    private static string SafeGet(string[] cells, int idx)
    {
        return idx >= 0 && idx < cells.Length ? (cells[idx] ?? "") : "";
    }

    private static string CleanCurrency(string raw)
    {
        if (string.IsNullOrWhiteSpace(raw)) return "";
        raw = raw.Trim();
        if (raw.Equals("On Track", StringComparison.OrdinalIgnoreCase) ||
            raw.Equals("Off Track", StringComparison.OrdinalIgnoreCase) ||
            raw.Equals("#N/A", StringComparison.OrdinalIgnoreCase))
            return "";
        return raw.Replace("$", "").Replace(",", "").Trim();
    }

    private static string CleanPercentage(string raw)
    {
        if (string.IsNullOrWhiteSpace(raw)) return "";
        raw = raw.Trim();
        if (raw.Equals("On Track", StringComparison.OrdinalIgnoreCase) ||
            raw.Equals("Off Track", StringComparison.OrdinalIgnoreCase) ||
            raw.Equals("#N/A", StringComparison.OrdinalIgnoreCase))
            return "";
        return raw.Replace("%", "").Trim();
    }

    // ── Auth ──
    private async Task CheckPassword()
    {
        if (_passwordInput == CorrectPassword)
        {
            _passwordError = string.Empty; _isAuthenticated = true; _showPasswordModal = false;
            try { await JSRuntime.InvokeVoidAsync("sessionStorage.setItem", "managerAuthenticated", "true"); } catch { }
        }
        else
        {
            _passwordError = "Incorrect password."; _passwordInput = string.Empty;
        }
        await InvokeAsync(StateHasChanged);
    }

    private async Task HandlePasswordKeydown(KeyboardEventArgs e) { if (e.Key == "Enter") await CheckPassword(); }

    // ── Save: current pod ──
    private async Task SaveMetrics()
    {
        if (_isSaving) return;
        _isSaving = true; _saveError = null; _saveSuccessMessage = null;

        if (_currentPodMembers == null || string.IsNullOrEmpty(_selectedPod) || string.IsNullOrEmpty(_selectedPeriod))
        { _saveError = "Pod and Period must be selected."; _isSaving = false; StateHasChanged(); return; }

        try
        {
            await SavePodMembers(_currentPodMembers, _inputValues);
            CalculateAllRankings();
            await AppState.NotifyMetricsUpdatedAsync();
            _saveSuccessMessage = $"Saved metrics for {_selectedPod}!";
        }
        catch (Exception ex)
        {
            _saveError = $"Error: {ex.Message}";
        }
        finally { _isSaving = false; StateHasChanged(); }
    }

    // ── Save: all parsed pods at once ──
    private async Task SaveAllPods()
    {
        if (_isSaving || string.IsNullOrEmpty(_selectedPeriod)) return;
        _isSaving = true; _saveError = null; _saveSuccessMessage = null;
        StateHasChanged();

        int savedPods = 0;
        int savedMembers = 0;
        var errors = new List<string>();

        try
        {
            foreach (var (podName, podData) in _parsedPodData)
            {
                var podMembers = _allPodMembers?
                    .Where(m => m.Department.Equals(podName, StringComparison.OrdinalIgnoreCase))
                    .ToList() ?? new();

                if (!podMembers.Any()) continue;

                var podInputs = new Dictionary<int, Dictionary<string, string>>();
                foreach (var (memberId, values) in podData)
                {
                    if (podMembers.Any(m => m.Id == memberId))
                        podInputs[memberId] = values;
                }

                try
                {
                    await SavePodMembers(podMembers.Where(m => podInputs.ContainsKey(m.Id)).ToList(), podInputs);
                    savedPods++;
                    savedMembers += podInputs.Count;
                }
                catch (Exception ex)
                {
                    errors.Add($"{podName}: {ex.Message}");
                }
            }

            CalculateAllRankings();
            await AppState.NotifyMetricsUpdatedAsync();

            _saveSuccessMessage = $"Saved {savedMembers} members across {savedPods} pods!";
            if (errors.Any())
                _saveError = $"Errors in: {string.Join("; ", errors)}";
        }
        catch (Exception ex)
        {
            _saveError = $"Error: {ex.Message}";
        }
        finally { _isSaving = false; StateHasChanged(); }
    }

    private async Task SavePodMembers(List<TeamMember> members, Dictionary<int, Dictionary<string, string>> inputValues)
    {
        var updateTasks = new List<Task>();

        foreach (var member in members)
        {
            if (!inputValues.TryGetValue(member.Id, out var memberInputs)) continue;

            bool hasAnyValue = memberInputs.Values.Any(v => !string.IsNullOrWhiteSpace(v));
            if (!hasAnyValue) continue;

            var records = new List<MetricRecord>();
            double totalWeightedScore = 0;
            int applicableWeight = 0;

            foreach (var metricKey in _podMetricKeys)
            {
                string rawVal = memberInputs.GetValueOrDefault(metricKey, "")?.Trim() ?? "";
                records.Add(new MetricRecord { TeamMemberId = member.Id, Period = _selectedPeriod!, MetricKey = metricKey, Value = rawVal });

                if (double.TryParse(rawVal, NumberStyles.Any, CultureInfo.InvariantCulture, out double numVal))
                {
                    int weight = _metricWeights.GetValueOrDefault(metricKey, 0);
                    double normalized;

                    if (metricKey == "Surveys" && numVal == 0)
                        normalized = 100.0;
                    else if ((metricKey == "AppEff" || metricKey == "PMEff"))
                    {
                        double target = _metricTargets.GetValueOrDefault(metricKey, 1.0);
                        normalized = target > 0 && numVal > 0 && numVal < 90000 ? (target / numVal) * 100.0 : 0;
                    }
                    else
                    {
                        double target = _metricTargets.GetValueOrDefault(metricKey, 1.0);
                        normalized = target > 0 ? (numVal / target) * 100.0 : 0;
                    }

                    normalized = Math.Clamp(normalized, 0, 100);
                    totalWeightedScore += normalized * weight;
                    applicableWeight += weight;
                }
            }

            updateTasks.Add(DataService.SaveMetricRecordsForPeriodAsync(member.Id, _selectedPeriod!, records));

            if (applicableWeight > 0)
            {
                double avgScore = totalWeightedScore / applicableWeight;
                member.TotalExperience += avgScore;
                updateTasks.Add(DataService.UpdateTeamMemberAsync(member));
            }
        }

        await Task.WhenAll(updateTasks);

        // Sync XP to master list
        if (_allPodMembers != null)
        {
            foreach (var updated in members)
            {
                var global = _allPodMembers.FirstOrDefault(m => m.Id == updated.Id);
                if (global != null) global.TotalExperience = updated.TotalExperience;
            }
        }
    }

    // ── Rankings ──
    private void CalculateAllRankings()
    {
        if (_allPodMembers == null || !_allPodMembers.Any()) return;
        _podRankings = new Dictionary<string, List<RankedMember>>();

        foreach (var pod in _pods)
        {
            var membersInPod = _allPodMembers.Where(m => m.Department.Equals(pod, StringComparison.OrdinalIgnoreCase)).ToList();
            if (!membersInPod.Any()) continue;

            var ranked = membersInPod
                .Select(m => new RankedMember { Id = m.Id, Name = m.Name, Department = m.Department, Score = m.TotalExperience })
                .OrderByDescending(rm => rm.Score)
                .Select((rm, idx) => { rm.Rank = idx + 1; return rm; })
                .ToList();

            _podRankings[pod] = ranked;
        }
        InvokeAsync(StateHasChanged);
    }

    // ── Clear / Nav ──
    private void ClearInputs() { InitializeInputValues(); _saveError = null; _saveSuccessMessage = null; StateHasChanged(); }
    private void ClearParseResults() { _parseResults = null; _parseLog.Clear(); _parsedPodData.Clear(); StateHasChanged(); }
    private void NavigateBack() => NavigationManager.NavigateTo("/pods");
}
